{
  "project": "nl2sql",
  "description": "一个基于 Langchain 的 nl2sql 项目",
  "tasks": [
    {
      "id": 1,
      "title": "项目初始化",
      "description": "项目初始化",
      "source": null,
      "priority": "p0",
      "steps": [
        "创建feature_list.json",
        "创建init.sh",
        "创建progress.md",
        "创建AGENTS.md"
      ],
      "files": [],
      "passes": true
    },
    {
      "id": 2,
      "title": "Phase 1: Schema 核心基础",
      "description": "实现 SQLite 数据库连接 + 基本 Schema 提取",
      "source": null,
      "priority": "p0",
      "module": "schema",
      "phase": 1,
      "steps": [
        "实现 DatabaseConnector（仅 SQLite）",
        "实现 SchemaExtractor 基本提取",
        "添加单元测试"
      ],
      "files": [
        "src/schema/database_connector.py",
        "src/schema/schema_extractor.py",
        "tests/test_schema_phase1.py"
      ],
      "passes": true
    },
    {
      "id": 3,
      "title": "Phase 2: Schema 文档生成",
      "description": "生成 LLM 可读的 Schema 文档 + 采样数据",
      "source": null,
      "priority": "p1",
      "module": "schema",
      "phase": 2,
      "steps": [
        "实现 SchemaDocGenerator",
        "添加采样数据功能",
        "添加单元测试"
      ],
      "files": [
        "src/schema/schema_doc_generator.py",
        "src/schema/schema_extractor.py",
        "tests/test_schema_phase2.py"
      ],
      "passes": true
    },
    {
      "id": 4,
      "title": "Phase 3: 语义增强",
      "description": "字段注释/业务含义注入，解决语义歧义",
      "source": null,
      "priority": "p1",
      "module": "schema",
      "phase": 3,
      "steps": [
        "实现 SchemaEnhancer",
        "实现配置文件加载",
        "创建字段描述配置模板",
        "添加单元测试"
      ],
      "files": [
        "src/schema/schema_enhancer.py",
        "config/field_descriptions.json",
        "tests/test_schema_phase3.py"
      ],
      "passes": true
    },
    {
      "id": 5,
      "title": "Phase 4: 关系提取",
      "description": "提取表之间的主键外键关系",
      "source": null,
      "priority": "p2",
      "module": "schema",
      "phase": 4,
      "steps": [
        "实现 RelationshipExtractor",
        "支持手动配置关系",
        "添加单元测试"
      ],
      "files": [
        "src/schema/relationship_extractor.py",
        "tests/test_schema_phase4.py"
      ],
      "passes": true
    },
    {
      "id": 6,
      "title": "Phase 5: 多数据源支持",
      "description": "支持 MySQL/PostgreSQL/Oracle，扩展为工厂模式",
      "source": null,
      "priority": "p5",
      "module": "schema",
      "phase": 5,
      "steps": [
        "扩展 DatabaseConnector 支持多类型",
        "实现 DatabaseConnectorFactory",
        "预留扩展接口",
        "添加单元测试"
      ],
      "files": [
        "src/schema/database_connector.py",
        "tests/test_schema_phase5.py"
      ],
      "passes": true
    },
    {
      "id": 7,
      "title": "Generation Phase 1: LLM工厂 + SQL生成器",
      "description": "实现 LLM 工厂 (支持 MiniMax M2.5) 和 SQL 生成器基础功能",
      "source": "docs/core-modules-2-phases.md",
      "priority": "p0",
      "module": "generation",
      "phase": 1,
      "steps": [
        "实现 LLMFactory (支持 minimax/openai/anthropic/ollama/custom)",
        "实现 SQLGenerator 基础功能",
        "添加单元测试"
      ],
      "files": [
        "src/generation/llm_factory.py",
        "src/generation/sql_generator.py",
        "tests/test_generation_phase1.py"
      ],
      "passes": true
    },
    {
      "id": 8,
      "title": "Generation Phase 2: Few-shot管理 + Prompt模板",
      "description": "实现 Few-shot 示例管理和多种 Prompt 模板",
      "source": "docs/core-modules-2-phases.md",
      "priority": "p1",
      "module": "generation",
      "phase": 2,
      "steps": [
        "实现 FewShotManager 示例管理",
        "实现 prompts.py 模板集合",
        "添加单元测试"
      ],
      "files": [
        "src/generation/few_shot_manager.py",
        "src/generation/prompts.py",
        "tests/test_generation_phase2.py"
      ],
      "passes": true
    },
    {
      "id": 9,
      "title": "Generation Phase 3: SQL验证器",
      "description": "实现 SQL 验证功能，防止危险操作",
      "source": "docs/core-modules-2-phases.md",
      "priority": "p2",
      "module": "generation",
      "phase": 3,
      "steps": [
        "实现 SQLValidator 验证功能",
        "添加单元测试"
      ],
      "files": [
        "src/generation/sql_validator.py",
        "tests/test_generation_phase3.py"
      ],
      "passes": true
    },
    {
      "id": 10,
      "title": "Execution Phase 1: 查询执行器 + 结果处理",
      "description": "实现 QueryExecutor 查询执行器和 ResultHandler 结果处理器",
      "source": "docs/core-modules-3.md",
      "priority": "p0",
      "module": "execution",
      "phase": 1,
      "steps": [
        "实现 QueryExecutor 基础执行",
        "实现错误捕获与重试逻辑",
        "实现 ResultHandler 结果处理",
        "添加单元测试"
      ],
      "files": [
        "src/execution/query_executor.py",
        "src/execution/result_handler.py",
        "tests/test_execution_phase1.py"
      ],
      "passes": true
    },
    {
      "id": 11,
      "title": "Execution Phase 2: 错误分析 + 重试策略",
      "description": "实现 ErrorAnalyzer 错误分析和 RetryConfig 重试策略",
      "source": "docs/core-modules-3.md",
      "priority": "p1",
      "module": "execution",
      "phase": 2,
      "steps": [
        "实现 ErrorAnalyzer 错误分析",
        "实现 RetryConfig 重试策略",
        "添加单元测试"
      ],
      "files": [
        "src/execution/error_analyzer.py",
        "tests/test_execution_phase2.py"
      ],
      "passes": true
    },
    {
      "id": 12,
      "title": "Execution Phase 3: 查询监控",
      "description": "实现 QueryMonitor 查询监控和慢查询检测",
      "source": "docs/core-modules-3.md",
      "priority": "p2",
      "module": "execution",
      "phase": 3,
      "steps": [
        "实现 QueryMonitor 查询监控",
        "实现慢查询检测",
        "添加单元测试"
      ],
      "files": [
        "src/execution/query_monitor.py",
        "tests/test_execution_phase3.py"
      ],
      "passes": true
    },
    {
      "id": 13,
      "title": "Semantic Phase 1: 核心映射功能",
      "description": "实现 SemanticMapper、TimeParser、ConfigManager 核心映射功能",
      "source": "docs/core-modules-4-phases.md",
      "priority": "p0",
      "module": "semantic",
      "phase": 1,
      "steps": [
        "实现 SemanticMapper 语义映射器",
        "实现 TimeParser 时间表达式解析",
        "实现 SemanticConfigManager 配置管理",
        "创建配置文件模板",
        "添加单元测试"
      ],
      "files": [
        "src/semantic/semantic_mapper.py",
        "src/semantic/time_parser.py",
        "src/semantic/config_manager.py",
        "config/semantic_mappings.json",
        "tests/test_semantic_phase1.py"
      ],
      "passes": true
    },
    {
      "id": 14,
      "title": "Semantic Phase 2: 向量语义匹配",
      "description": "实现 VectorMatcher 向量语义匹配功能",
      "source": "docs/core-modules-4-phases.md",
      "priority": "p1",
      "module": "semantic",
      "phase": 2,
      "steps": [
        "实现 VectorMatcher 向量匹配",
        "实现余弦相似度计算",
        "添加单元测试"
      ],
      "files": [
        "src/semantic/vector_matcher.py",
        "tests/test_semantic_phase2.py"
      ],
      "passes": true
    },
    {
      "id": 15,
      "title": "Semantic Phase 3: 上下文感知映射",
      "description": "实现 ContextAwareMapper 上下文感知字段消解",
      "source": "docs/core-modules-4-phases.md",
      "priority": "p1",
      "module": "semantic",
      "phase": 3,
      "steps": [
        "实现 ContextAwareMapper 上下文感知",
        "实现字段歧义消解",
        "添加单元测试"
      ],
      "files": [
        "src/semantic/context_aware_mapper.py",
        "tests/test_semantic_phase3.py"
      ],
      "passes": true
    },
    {
      "id": 16,
      "title": "Security Phase 1: SQL安全验证 + 权限管理",
      "description": "实现 SQLSecurityValidator 和 PermissionManager",
      "source": "docs/core-modules-5-phases.md",
      "priority": "p0",
      "module": "security",
      "phase": 1,
      "steps": [
        "实现 SQLSecurityValidator 基础验证",
        "实现 PermissionManager 权限管理",
        "创建安全策略配置模板",
        "添加单元测试"
      ],
      "files": [
        "src/security/sql_validator.py",
        "src/security/permission_manager.py",
        "config/security_policy.json",
        "tests/test_security_phase1.py"
      ],
      "passes": true
    },
    {
      "id": 17,
      "title": "Security Phase 2: 敏感数据过滤 + 注入检测",
      "description": "实现 SensitiveDataFilter 和 SQLInjectionDetector",
      "source": "docs/core-modules-5-phases.md",
      "priority": "p1",
      "module": "security",
      "phase": 2,
      "steps": [
        "实现 SensitiveDataFilter 敏感数据过滤",
        "实现 SQLInjectionDetector 注入检测",
        "添加单元测试"
      ],
      "files": [
        "src/security/sensitive_filter.py",
        "src/security/injection_detector.py",
        "tests/test_security_phase2.py"
      ],
      "passes": true
    },
    {
      "id": 19,
      "title": "Explanation Phase 1: 核心解释功能",
      "description": "实现 ResultExplainer 结果解释器、DataAnalyst 数据分析师、ResultFormatter 格式化器",
      "source": "docs/core-modules-6-phases.md",
      "priority": "p0",
      "module": "explanation",
      "phase": 1,
      "steps": [
        "实现 ResultExplainer 结果解释器主类",
        "实现 DataAnalyst 数据分析师",
        "实现 ResultFormatter 格式化器集合",
        "添加单元测试"
      ],
      "files": [
        "src/explanation/result_explainer.py",
        "src/explanation/data_analyst.py",
        "src/explanation/formatters.py",
        "tests/test_explanation_phase1.py"
      ],
      "passes": true
    },
    {
      "id": 20,
      "title": "Explanation Phase 2: 高级分析功能",
      "description": "实现 ResultSummarizer 智能摘要生成和 ComparisonAnalyzer 对比分析器",
      "source": "docs/core-modules-6-phases.md",
      "priority": "p1",
      "module": "explanation",
      "phase": 2,
      "steps": [
        "实现 ResultSummarizer 摘要生成器",
        "实现 ComparisonAnalyzer 对比分析器",
        "添加单元测试"
      ],
      "files": [
        "src/explanation/summarizer.py",
        "src/explanation/comparator.py",
        "tests/test_explanation_phase2.py"
      ],
      "passes": true
    },
    {
      "id": 21,
      "title": "Explanation Phase 3: Prompt 模板集成",
      "description": "实现多种解释 Prompt 模板（简洁回答、详细分析、对比分析）",
      "source": "docs/core-modules-6-phases.md",
      "priority": "p1",
      "module": "explanation",
      "phase": 3,
      "steps": [
        " 模板",
        "实现详细分析 Prompt 模板",
        "实现对比实现简洁回答 Prompt分析 Prompt 模板",
        "添加单元测试"
      ],
      "files": [
        "src/explanation/prompts.py",
        "tests/test_explanation_phase3.py"
      ],
      "passes": true
    },
    {
      "id": 22,
      "title": "Explanation Phase 4: 多格式输出支持",
      "description": "支持多种输出格式（JSON、Markdown、表格）和多语言支持",
      "source": "docs/core-modules-6-phases.md",
      "priority": "p2",
      "module": "explanation",
      "phase": 4,
      "steps": [
        "扩展 ResultFormatter 支持更多格式",
        "添加多语言支持（中英文）",
        "添加单元测试"
      ],
      "files": [
        "src/explanation/formatters.py",
        "tests/test_explanation_phase4.py"
      ],
      "passes": true
    },
    {
      "id": 23,
      "title": "Explanation Phase 5: 集成测试与优化",
      "description": "模块集成测试、性能优化和错误处理完善",
      "source": "docs/core-modules-6-phases.md",
      "priority": "p1",
      "module": "explanation",
      "phase": 5,
      "steps": [
        "集成测试所有组件",
        "性能优化",
        "完善错误处理",
        "添加端到端测试"
      ],
      "files": [
        "tests/test_explanation_integration.py",
        "tests/test_explanation_e2e.py"
      ],
      "passes": true
    },
    {
      "id": 24,
      "title": "Orchestrator Phase 1: 核心类型定义",
      "description": "定义编排器所需的全部数据类型，包括查询状态、结果结构等",
      "source": "docs/orchestrator-design-phases.md",
      "priority": "p0",
      "module": "orchestrator",
      "phase": 1,
      "steps": [
        "实现 QueryStatus 枚举",
        "实现 MappingResult 数据类",
        "实现 SecurityResult 数据类",
        "实现 ExecutionResult 数据类",
        "实现 QueryResult 数据类",
        "添加单元测试"
      ],
      "files": [
        "src/core/types.py",
        "src/core/__init__.py",
        "tests/test_core_types.py"
      ],
      "passes": true
    },
    {
      "id": 25,
      "title": "Orchestrator Phase 2: 编排器基础架构",
      "description": "实现编排器主类框架，包括模块初始化和核心 ask 方法",
      "source": "docs/orchestrator-design-phases.md",
      "priority": "p0",
      "module": "orchestrator",
      "phase": 2,
      "steps": [
        "实现 NL2SQLOrchestrator 主类",
        "实现 _init_modules 方法初始化6个模块",
        "实现 ask 方法骨架",
        "实现 get_table_names 方法",
        "实现 get_schema 方法",
        "添加单元测试"
      ],
      "files": [
        "src/core/orchestrator.py",
        "tests/test_orchestrator_phase2.py"
      ],
      "passes": true
    },
    {
      "id": 26,
      "title": "Orchestrator Phase 3: 语义映射集成",
      "description": "实现 _semantic_mapping 方法，将语义模块集成到编排流程",
      "source": "docs/orchestrator-design-phases.md",
      "priority": "p1",
      "module": "orchestrator",
      "phase": 3,
      "steps": [
        "实现 _semantic_mapping 方法",
        "集成 SemanticMapper",
        "集成 SemanticConfigManager",
        "添加单元测试"
      ],
      "files": [
        "src/core/orchestrator.py",
        "tests/test_orchestrator_phase3.py"
      ],
      "passes": true
    },
    {
      "id": 27,
      "title": "Orchestrator Phase 4: Schema + SQL生成 + 安全验证集成",
      "description": "实现 Schema 准备、SQL 生成和安全验证方法",
      "source": "docs/orchestrator-design-phases.md",
      "priority": "p1",
      "module": "orchestrator",
      "phase": 4,
      "steps": [
        "实现 _prepare_schema 方法",
        "实现 _generate_sql 方法",
        "实现 _validate_security 方法",
        "集成 SchemaGenerator、SQLGenerator、SecurityValidator",
        "添加单元测试"
      ],
      "files": [
        "src/core/orchestrator.py",
        "tests/test_orchestrator_phase4.py"
      ],
      "passes": true
    },
    {
      "id": 28,
      "title": "Orchestrator Phase 5: 执行与结果解释集成",
      "description": "实现 SQL 执行和结果解释方法，完成完整流程",
      "source": "docs/orchestrator-design-phases.md",
      "priority": "p1",
      "module": "orchestrator",
      "phase": 5,
      "steps": [
        "实现 _execute_sql 方法",
        "实现 _explain_result 方法",
        "集成 QueryExecutor、ResultExplainer",
        "添加单元测试"
      ],
      "files": [
        "src/core/orchestrator.py",
        "tests/test_orchestrator_phase5.py"
      ],
      "passes": true
    },
    {
      "id": 29,
      "title": "Orchestrator Phase 6: 集成测试",
      "description": "创建完整的端到端集成测试，验证6大模块协作",
      "source": "docs/orchestrator-design-phases.md",
      "priority": "p0",
      "module": "orchestrator",
      "phase": 6,
      "steps": [
        "创建测试数据库 Fixture",
        "实现简单查询端到端测试",
        "实现条件查询端到端测试",
        "实现聚合查询端到端测试",
        "实现关联查询端到端测试",
        "实现安全拦截测试",
        "实现执行错误处理测试"
      ],
      "files": [
        "tests/conftest.py",
        "tests/test_orchestrator_integration.py",
        "tests/fixtures/questions.json"
      ],
      "passes": true
    },
    {
      "id": 30,
      "title": "CLI & API Phase 1: YAML 配置系统",
      "description": "创建 YAML 格式配置文件，支持结构化配置管理",
      "source": "docs/implementation-plan-cli-api-phases.md",
      "priority": "p0",
      "module": "core",
      "phase": 1,
      "steps": [
        "创建 config/settings.yaml 文件",
        "定义 LLM 配置（provider, model, api_key, temperature）",
        "定义 Database 配置（uri）",
        "定义 Security 配置（read_only, max_retries, timeout, allowed_tables）",
        "定义 Paths 配置（field_descriptions, semantic_mappings, security_policy）",
        "定义 API 配置（host, port, cors_origins）",
        "定义 Logging 配置（level, format）"
      ],
      "files": [
        "config/settings.yaml"
      ],
      "passes": true
    },
    {
      "id": 31,
      "title": "CLI & API Phase 2: 配置系统增强",
      "description": "更新 src/config.py 支持 YAML 配置加载，与 .env 兼容",
      "source": "docs/implementation-plan-cli-api-phases.md",
      "priority": "p0",
      "module": "core",
      "phase": 2,
      "steps": [
        "添加 pyyaml 导入",
        "添加 lru_cache 装饰器",
        "创建 get_yaml_settings() 类方法",
        "实现配置合并逻辑（yaml < .env < explicit kwargs）",
        "更新字段命名（添加 llm_ 前缀）",
        "添加 API 相关配置字段"
      ],
      "files": [
        "src/config.py"
      ],
      "passes": true
    },
    {
      "id": 32,
      "title": "CLI & API Phase 3: 主入口实现",
      "description": "实现 src/main.py 提供 CLI 和 FastAPI 双模式入口",
      "source": "docs/implementation-plan-cli-api-phases.md",
      "priority": "p0",
      "module": "core",
      "phase": 3,
      "steps": [
        "定义 create_orchestrator(settings) 函数",
        "实现 CLI 模式 run_cli(args, settings)",
        "实现 FastAPI 工厂 create_app(settings)",
        "实现 /query 端点（POST）",
        "实现 /tables 端点（GET）",
        "实现 /schema/{table_name} 端点（GET）",
        "实现 /health 端点（GET）",
        "配置 CORS",
        "创建 main() 入口函数",
        "支持 cli/api 子命令"
      ],
      "files": [
        "src/main.py"
      ],
      "passes": true
    },
    {
      "id": 33,
      "title": "CLI & API Phase 4: 依赖更新",
      "description": "添加 FastAPI 相关依赖到项目",
      "source": "docs/implementation-plan-cli-api-phases.md",
      "priority": "p0",
      "module": "core",
      "phase": 4,
      "steps": [
        "在 pyproject.toml 添加 fastapi >= 0.100.0",
        "在 pyproject.toml 添加 uvicorn >= 0.20.0",
        "在 pyproject.toml 添加 pyyaml >= 6.0",
        "更新 requirements.txt"
      ],
      "files": [
        "pyproject.toml",
        "requirements.txt"
      ],
      "passes": true
    },
    {
      "id": 34,
      "title": "CLI & API Phase 5: 测试验证",
      "description": "创建完整的测试用例验证 CLI 和 API 功能",
      "source": "docs/implementation-plan-cli-api-testing.md",
      "priority": "p1",
      "module": "core",
      "phase": 5,
      "steps": [
        "创建 tests/test_cli.py CLI 测试",
        "创建 tests/test_api.py API 测试",
        "创建 tests/test_config.py 配置测试",
        "测试 CLI 基本查询",
        "测试 CLI 安全拒绝",
        "测试 API /health 端点",
        "测试 API /tables 端点",
        "测试 API /schema/{table} 端点",
        "测试 API /query 端点",
        "测试配置加载优先级",
        "运行回归测试"
      ],
      "files": [
        "tests/test_cli.py",
        "tests/test_api.py",
        "tests/test_config.py"
      ],
      "passes": true
    },
    {
      "id": 35,
      "title": "CLI & API 流式响应支持",
      "description": "为 CLI 和 REST API 增加流式响应支持，支持实时获取查询进度和中间结果",
      "source": ".sisyphus/plans/streaming-response-plan.md",
      "priority": "p1",
      "module": "core",
      "phase": 6,
      "steps": [
        "修改 LLM Factory 添加 stream 参数到 create_llm() 函数",
        "在 SQLGenerator 新增 generate_stream() 方法，使用 LangChain .stream() API",
        "在 ResultExplainer 新增 explain_stream() 方法，流式解释查询结果",
        "在 Orchestrator 新增 ask_stream() 方法，分阶段 yield 流式数据",
        "在 CLI run_cli() 函数添加 --stream 参数支持流式输出",
        "在 REST API 新增 /query/stream 端点，使用 SSE (Server-Sent Events) 流式响应",
        "添加单元测试验证各模块流式功能",
        "添加集成测试验证 CLI --stream 参数",
        "添加集成测试验证 API /query/stream 端点"
      ],
      "files": [
        "src/generation/llm_factory.py",
        "src/generation/sql_generator.py",
        "src/explanation/result_explainer.py",
        "src/core/orchestrator.py",
        "src/main.py",
        "tests/test_llm_factory_stream.py",
        "tests/test_sql_generator_stream.py",
        "tests/test_orchestrator_stream.py",
        "tests/test_cli_stream.py",
        "tests/test_api_stream.py"
      ],
      "passes": false
    }
  ]
}